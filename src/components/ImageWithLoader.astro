---
import { Image } from "astro:assets";

interface Props {
    src: string | ImageMetadata;
    alt: string;
    class?: string;
    width?: number;
    height?: number;
    loading?: "lazy" | "eager";
    decoding?: "async" | "sync" | "auto";
}

const {
    src,
    alt,
    class: className,
    width,
    height,
    loading = "lazy",
    decoding = "async",
} = Astro.props;

// Generate unique ID for this image loader
const loaderId = `img-loader-${Math.random().toString(36).substring(2, 9)}`;
---

<div class="relative inline-block w-full h-full" data-image-loader={loaderId}>
    <!-- Loading skeleton -->
    <div
        class="absolute inset-0 bg-gradient-to-r from-gray-800 via-gray-700 to-gray-800 animate-pulse rounded"
        data-loader-skeleton
    >
        <div class="flex items-center justify-center h-full">
            <svg
                class="w-10 h-10 text-gray-600 animate-spin"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
            >
                <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="4"></circle>
                <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
            </svg>
        </div>
    </div>

    <!-- Actual image -->
    {
        typeof src === "string" ? (
            <img
                src={src}
                alt={alt}
                class:list={[className, "opacity-0 transition-opacity duration-300"]}
                width={width}
                height={height}
                loading={loading}
                decoding={decoding}
                data-image-target
            />
        ) : (
            <Image
                src={src}
                alt={alt}
                class:list={[className, "opacity-0 transition-opacity duration-300"]}
                width={width}
                height={height}
                loading={loading}
                decoding={decoding}
                data-image-target
            />
        )
    }
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const imageLoaders = document.querySelectorAll("[data-image-loader]");

        imageLoaders.forEach((loader) => {
            const img = loader.querySelector(
                "[data-image-target]",
            ) as HTMLImageElement;
            const skeleton = loader.querySelector("[data-loader-skeleton]");

            if (!img || !skeleton) return;

            const handleImageLoad = () => {
                // Fade in image
                img.classList.remove("opacity-0");
                img.classList.add("opacity-100");

                // Fade out skeleton
                skeleton.classList.add("opacity-0", "transition-opacity", "duration-300");

                // Remove skeleton after animation
                setTimeout(() => {
                    skeleton.remove();
                }, 300);
            };

            const handleImageError = () => {
                // Show error state
                skeleton.innerHTML = `
                    <div class="flex items-center justify-center h-full text-gray-500">
                        <svg class="w-10 h-10" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                `;
            };

            if (img.complete && img.naturalHeight !== 0) {
                // Image already loaded
                handleImageLoad();
            } else {
                img.addEventListener("load", handleImageLoad);
                img.addEventListener("error", handleImageError);
            }
        });
    });
</script>
